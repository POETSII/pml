<?xml version="1.0"?>
<Graphs xmlns="https://poets-project.org/schemas/virtual-graph-schema-v2">
    <GraphType id="ro">
        <Documentation>TODO</Documentation>
        <MetaData>&quot;native_dimension&quot;:2</MetaData>
        <Properties/>

        <MessageTypes>

            <MessageType id="__init__">
                <Documentation>Initialize state</Documentation>
            </MessageType>

            <MessageType id="toggle">
                <Message>
                </Message>
                <Documentation>Trigger next node to toggle state</Documentation>
            </MessageType>

        </MessageTypes>

        <DeviceTypes>
            <DeviceType id="node">

                <State>
                    <Scalar name="state" type="uint32_t"/>
                    <Scalar name="counter" type="uint32_t"/>
                    <Scalar name="rts" type="uint32_t"/>
                </State>

                <Properties>
                    <Scalar name="id" type="uint32_t"/>
                </Properties>

                <ReadyToSend>
                    <![CDATA[
                    *readyToSend = deviceState->rts;
                    ]]>
                </ReadyToSend>

                <InputPin messageTypeId="__init__" name="__init__">
                    <OnReceive>
                        <![CDATA[
                        if (deviceProperties->id == 1) {
                            deviceState->rts = 1;
                        }
                        ]]>
                    </OnReceive>
                </InputPin>

                <InputPin messageTypeId="toggle" name="in">
                    <OnReceive>
                        <![CDATA[
                        deviceState->state = 1 - deviceState->state; // toggle state

                        (deviceState->counter)++; // increment counter

                        deviceState->rts = 1; // queue next message for sending
                        ]]>
                    </OnReceive>
                </InputPin>

                <OutputPin messageTypeId="toggle" name="out">
                    <OnSend>
                        <![CDATA[

                        deviceState->rts = 0;

                        ]]>
                    </OnSend>
                </OutputPin>

            </DeviceType>

        </DeviceTypes>
    </GraphType>
    <GraphInstance id="graph1" graphTypeId="ro">
      <DeviceInstances>
        {%- for node in node_info %}
        <DevI id="{{ node.name }}" type="node"><P>"id": {{ node.index }}</P></DevI>
        {%- endfor %}
      </DeviceInstances>
      <EdgeInstances>
        {%- for src, dst in edges %}
        <EdgeI path="{{ src }}:in-{{ dst }}:out"/>
        {%- endfor %}
      </EdgeInstances>
    </GraphInstance>
</Graphs>